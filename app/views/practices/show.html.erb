<%- model_class = Practice -%>

<div class="container col-xs-11 col-sm-10 col-md-8 affix">
  <div class="btn-toolbar pull-right" role="toolbar" arial-label="toolbar">
    <!-- 管理功能 -->
    <div class="btn-group" role="group" arial-label="manage">
      <% if current_user.id == @practice.user_id  %>
        <%= link_to t('.new', :default => t("helpers.links.new")), new_practice_path, :class => 'btn btn-default', tabindex: 51, "data-toggle": "tooltip", "data-placement": "bottom", title: t('.new', :default => [:"helpers.titles.new"], :model => model_class.model_name.human.titleize) %>
        <%= link_to t('.edit', :default => t("helpers.links.edit")), edit_practice_path(@practice), :class => 'btn btn-default', tabindex: 52, "data-toggle": "tooltip", "data-placement": "bottom", title: t('.edit', :default => [:"helpers.titles.edit"], :model => model_class.model_name.human.titleize) %>
        <%= link_to t('.destroy', :default => t("helpers.links.destroy")),
          practice_path(@practice),
          :method => 'delete',
          :data => { :confirm => t('.confirm', :default => t("helpers.links.confirm", :default => 'Are you sure?')) },
          :class => 'btn btn-default', tabindex: 53, "data-toggle": "tooltip", "data-placement": "bottom", title: t('.delete', :default => [:"helpers.titles.delete"], :model => model_class.model_name.human.titleize) %>
      <% end %>
      <%= link_to t('.back', :default => t("helpers.links.back")),
        practices_path, :class => 'btn btn-default', tabindex: 54, "data-toggle": "tooltip", "data-placement": "bottom", title: t('.back', :default => [:"helpers.titles.back"], :model => model_class.model_name.human.titleize)  %>
    </div>
   <!-- 附加功能 -->
    <div class="btn-group" role="btn-group" arial-label="operation">
      <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        <span class="caret"></span>
      </button>
      <ul class="dropdown-menu">
        <li>
          <%= link_to "在卡片盒中添加本习题", "#myCard", data: {toggle: "modal"}  %>
        </li>
        <li>
          <%= link_to "管理卡片盒", cardboxes_url %>
        </li>
        <% if session[:paper_id] %>
          <li>
            <%= link_to "将本题添加到试卷中", practice_add_to_paper_url(@practice.id) %>
          </li>
        <% end %>
      </ul>
    </div>
    <!-- 导航按钮 -->
    <div class="btn-group" role="btn-group" arial-label="navigation">
      <% if @previous_practice %>
        <%= link_to t('.previous', :default => t("helpers.links.previous")), practice_path(@previous_practice), class: 'btn btn-default', "data-toggle": "tooltip", "data-placement": "bottom", title: t('.previous', default: t("helpers.titles.previous"), :model => t("activerecord.models.practice")) %>
      <% end %>
      <% if @next_practice %>
        <%= link_to t('.next', :default => t("helpers.links.next")), practice_path(@next_practice), class: 'btn btn-default', "data-toggle": "tooltip", "data-placement": "bottom", title: t('.next', default: t("helpers.titles.next"), :model => t("activerecord.models.practice")) %>
      <% end %>
      <% if session[:textbook_id] %>
        <%= link_to t('.up', :default => t("helpers.links.up")), lesson_url(@lesson), class: 'btn btn-default', "data-toggle": "tooltip", "data-placement": "bottom", title: t('.up', default: t("helpers.titles.up"), :model => t("activerecord.models.lesson")) %>
      <% end %>
      <%= link_to t('.retreat', :default => t("helpers.links.retreat")), :back, :class => 'btn btn-default', "data-toggle": "tooltip", "data-placement": "bottom", title: t('.retreat', :default => [:"helpers.titles.retreat"]) %>
    </div>
  </div>
</div>

<div class="page-header">
    <h5>《<%= @lesson.title %>》一课的练习</h5>
</div>

<div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
  <div class="panel panel-success">
    <div class="panel-heading" role="tab" id="headingOne">
        <span class="pull-right">标签：<%= @practice.labelname || "无" %></span>
        <p class="paragraph"><%= @practice.title %></p>
      <div class="paragraph">
        <p>
        <%= sanitize(@practice.material, tags: %w(div a acronym b strong i em li ul ol h1 h2 h3 h4 h5 h6 hr blockquote br cite sub sup ins p ruby rt rp table tr td span u ), attributes: %w(href class style)) %>
        </p>
        <p>
        <%= sanitize(@practice.question, tags: %w(div a acronym b strong i em li ul ol h1 h2 h3 h4 h5 h6 hr blockquote br cite sub sup ins p ruby rt rp table tr td span u ), attributes: %w(href class style)) %>
        </p>
        <% if @practice.picture_q_file_name %>
          <%= image_tag @practice.picture_q.url, class: "img-responsive center-block"  %>
        <% end %>
      </div>

      <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne" class="bg-success center-block">
        <p class="text-center">...</p>
      </a>
    </div>
    <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
      <div class="panel-body">
      <div class="paragraph">
      <p><%= sanitize(@practice.answer) %></p>
      </div>
      <% if @practice.picture_a_file_name %>
        <%= image_tag @practice.picture_a.url, class: "img-responsive center-block"  %>
      <% end %>
        <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne" class="bg-success center-block">
          <p class="text-center">...</p>
        </a>
      </div>
    </div>
  </div>
</div>


<!-- Modal -->
<% if current_user %>
<div class="modal fade" id="myCard" tabindex="-1" role="dialog" aria-labelledby="myCardLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myCardLabel">添加到这个卡片盒中：</h4>
      </div>

      <% @card = Card.new %>
      <% @card.user_id = current_user.id %>
      <% @card.practice_id = @practice.id %>
      <%= form_for @card, :html => { :class => "form-horizontal card" } do |f| %>

        <div class="modal-body">
          <% if @card.errors.any? %>
            <div id="error_expl" class="panel panel-danger">
              <div class="panel-heading">
                <h3 class="panel-title"><%= pluralize(@card.errors.count, "error") %> 使这个卡片无法提交:</h3>
              </div>
              <div class="panel-body">
                <ul>
                <% @card.errors.full_messages.each do |msg| %>
                  <li><%= msg %></li>
                <% end %>
                </ul>
              </div>
            </div>
          <% end %>

          <div class="control-group">
            <div class="controls">
              <%= f.hidden_field :user_id, :class => 'form-control' %>
            </div>
            <%= error_span(@card[:user_id]) %>
          </div>
          <div class="control-group">
            <div class="controls">
              <%= f.hidden_field :practice_id, :class => 'form-control' %>
            </div>
            <%= error_span(@card[:practice_id]) %>
          </div>
          <div class="control-group">
            <%= f.label :cardbox_id, :class => 'control-label col-md-2' %>
            <div class="controls">
              <%= f.select :cardbox_id, Cardbox.where(user_id: current_user.id, lesson_id: session[:lesson_id]).collect{ |cardbox| [cardbox.name, cardbox.id]}, {prompt: "请选择一个卡片盒"}, {:class => 'form-control col-md-4'} %>
            </div>
            <%= error_span(@card[:cardbox_id]) %>
          </div>
        </div>

        <div class="modal-footer">
          <p class="text-left"><b>提示：</b>若点击“提交”后没有反应，可刷新网页再点击“提交”。</p>
          <%= f.submit "提交", :class => 'btn btn-primary' %>
          <button type="button" class="btn btn-default" data-dismiss="modal">取消</button> 
        </div>
      <% end %> <!-- form_for -->
    </div>
  </div>
</div>
<% end %>

<% if current_user.has_role? :admin %>

<hr>
<dl class="dl-horizontal">
  <dt><strong><%= model_class.human_attribute_name(:user_id) %>:</strong></dt>
  <dd><%= @practice.user_id %></dd>
  <dt><strong><%= model_class.human_attribute_name(:tutor_id) %>:</strong></dt>
  <dd><%= @practice.tutor_id %></dd>
  <dt><strong><%= model_class.human_attribute_name(:lesson_id) %>:</strong></dt>
  <dd><%= @practice.lesson_id %></dd>
  <dt><strong><%= model_class.human_attribute_name(:activate) %>:</strong></dt>
  <dd><%= @practice.activate %></dd>
</dl>

<% end %>
